# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>Protection des machines virtuelles invité contre CVE-2017-5715 (injection cible de branche)

Cette page fournit des informations supplémentaires sur la protection des machines virtuelles sur des hôtes Hyper-V contre CVE-2017-5715 (injection cible de branche).  Pour des recommandations générales Windows Server, veuillez vous référer à [cette page](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

Les étapes suivantes sont requises pour vous assurer que vos machines virtuelles sont protégées:

1. Mettez à jour le système d'exploitation hôte.
2. Vérifiez que l’hôte de virtualisation a été mis à jour avec le microprogramme contenant des mises à jour pour CVE-2017-5715.
3. Vérifiez qu'Hyper-V est configuré pour exposer de nouvelles fonctionnalités de processeur aux machines virtuelles invité.
4. Mettez à jour le système d’exploitation invité, le cas échéant. 
5. Effectuez un démarrage à froid des machines virtuelles invité.

## <a name="update-the-host-operating-system"></a>Mettre à jour le système d'exploitation hôte

Appliquez la mise à jour du système d’exploitation Windows à l’hôte de virtualisation. Pour en savoir plus sur l’activation de cette mise à jour, consultez [l’article4072699 de la Base de connaissances Microsoft](https://support.microsoft.com/help/4072699).

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>Vérifier que l’hôte de virtualisation a été mis à jour avec le microprogramme contenant des mises à jour pour CVE-2017-5715

Les mises à jour du microprogramme de votre OEM peuvent contenir de nouvelles fonctionnalités de processeur pouvant servir de protection contre CVE-2017-5715 ([IBRS, STIBP, IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)).  Une fois que le microprogramme de l’hôte de virtualisation a été mis à jour, l’hyperviseur peut mettre ces fonctionnalités supplémentaires à disposition des machines virtuelles invité après avoir réalisé les étapes suivantes.

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>Vérifier qu'Hyper-V est configuré pour exposer de nouvelles fonctionnalités de processeur aux machines virtuelles invité

Assurez-vous que Hyper-V est configuré pour exposer les nouvelles fonctionnalités de processeur aux machines virtuelles invitées.  Cette configuration est fondée sur la [version VM](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server) des machines virtuelles invité. 

Si toutes les machines virtuelles sur l'hôte sont des ordinateurs virtuels version8.0 ou supérieure, aucune configuration n’est requise.  Ces machines virtuelles détecteront les nouvelles fonctionnalités de processeur après un démarrage à froid.

En cas de machine virtuelle avec une version d'ordinateur virtuel inférieure à8.0, vous devez définir une valeur de registre spécifique sur le système d’exploitation hôte.  Cette opération configurera Hyper-V pour exposer les nouvelles fonctionnalités de processeur aux machines virtuelles invité avec des versions inférieures d'ordinateurs virtuels.

Cette valeur de registre est `MinVmVersionForCpuBasedMitigations` sous `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`.  La valeur doit être définie pour la version minimale d'ordinateur virtuel devant accéder aux fonctionnalités de mise à jour du microprogramme, au format «Majeure.Mineure».  Pour exposer le microprogramme à toutes les machines virtuelles sur l'hôte (c.-à-d. version1.0 ou supérieure), exécutez la commande suivante sur l’hôte: 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*Remarque: la version d'ordinateur virtuel8.0 a été introduite avec Windows Server2016 et la mise à jour anniversaire Windows10.  Les hôtes exécutant Windows Server2012R2 ou version inférieure doivent définir la valeur de registre*

*Avertissement: la migration dynamique échouera entre les hôtes avec le microprogramme mis à jour et les hôtes sans le microprogramme mis à jour.  Pour en savoir plus, consultez le FAQ en bas de ce document.*

## <a name="optional-configure-pre-skylake-intel-systems-to-use-retpoline"></a>*Facultatif*: configurer les _Paramètres pré-Skylake_ Intel systèmes pour utiliser Retpoline

*Avertissement: la configuration de machines virtuelles sur des hôtes de Intel pre-Skylake pour Retpoline bloque la migration dynamique vers des hôtes plus récents (autrement dit, Skylake et ultérieures).*

Par défaut, les machines virtuelles en cours d’exécution sur les systèmes de pré-Skylake ne peuvent pas à l’aide de retpoline.  Pour autoriser ces systèmes tirer parti des retpoline en fonction de mesures de prévention, définissez `RetsPredictedFromRsbOnly` sous `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` à `1`. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

Pour annuler cette configuration (autrement dit, empêcher des machines virtuelles de tirer parti de retpoline), définissez `RetsPredictedFromRsbOnly` à `0`.

## <a name="update-the-guest-operating-system"></a>Mettre à jour le système d'exploitation invité

Pour terminer la configuration de la protection contre CVE-2017-5715 au sein de ces machines virtuelles, le système d’exploitation invité doit être mis à jour et configuré pour tirer parti de ces nouvelles fonctionnalités.  Pour les systèmes d’exploitation Microsoft, veuillez suivre les recommandations de [cet article](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) lors de la mise à jour.

*Remarque: la mise à jour du système d’exploitation invité peut survenir à tout moment au cours de ce processus.  Elle peut se produire avant la mise à jour du microprogramme de l’hôte ou après le démarrage à froid de la machine virtuelle invité.*

## <a name="perform-a-cold-boot-of-the-guest"></a>Réaliser un démarrage à froid de l'invité

Après avoir effectué les trois premières étapes, les machines virtuelles doivent subir un démarrage à froid pour détecter les nouvelles fonctionnalités de processeur.  Autrement dit, les ordinateurs virtuels en cours d’exécution doivent être complètement mis hors tension avant de redémarrer.  Le redémarrage à partir de l’intérieur du système d’exploitation invité n’est pas suffisant.

## <a name="frequently-asked-questions"></a>Forum Aux Questions

### <a name="how-does-this-impact-live-migration"></a>Quel est l'impact de cette opération sur la migration dynamique?

La migration dynamique d’une machine virtuelle avec les nouvelles fonctionnalités de processeur échouera en cas de déplacement vers des hôtes Hyper-V sans microprogramme mis à jour.  Pour activer la migration dynamique vers un hôte sans microprogramme mis à jour, arrêtez l'exposition des fonctionnalités de processeur mises à jour au sein de la machine virtuelle concernée.  Le moyen le plus simple d'y parvenir consiste à mettre à niveau `MinVmVersionForCpuBasedMitigations` avec une version d’ordinateur virtuel supérieure à celle de la machine virtuelle devant être migrée, puis à effectuer un démarrage à froid de cette machine virtuelle.

La migration d’une machine virtuelle sans les nouvelles fonctionnalités de processeur réussira en cas de déplacement vers des hôtes Hyper-V avec microprogramme mis à jour.  Cependant, ces invités doivent subir un démarrage à froid afin de détecter les fonctionnalités du microprogramme mis à jour.

Machines virtuelles configurées pour utiliser Retpoline sur les systèmes Intel pre-Skylake échoue à migrer vers les nouvelles familles de processeurs (autrement dit, Skylake et versions ultérieures).

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>Qu’en est-il de la migration dynamique de machines virtuelles version5.0 entre WindowsServer2012R2 et Windows Server2016?
Pour garantir la réussite de l'opération dans ce scénario, la valeur de registre doit être définie à la fois sur le système Windows Server2012R2 et le système Windows Server2016.  Après la migration vers Windows Server2016, la version d'ordinateur virtuel reste5.0. La clé de registre est donc requise pour exposer les nouvelles fonctionnalités de processeur à la machine virtuelle.  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>Ces recommandations s’appliquent-elles aux machines virtuelles s'exécutant sur VMWare?
Non. Ces recommandations sont spécifiques aux machines virtuelles s’exécutant sur des hôtes Hyper-V.

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>Ces recommandations s’appliquent-elles à Hyper-V sur Windows10?
Oui. Les mêmes étapes s’appliquent aux machines virtuelles s’exécutant sur Windows Server et Windows Client.

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>Dois-je installer les mises à jour du microprogramme avant d’effectuer un démarrage à froid des machines virtuelles?
Oui. Vous devez mettre à jour le système d’exploitation hôte et le microprogramme avant d'effectuer un démarrage à froid de vos machines virtuelles.

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>Que puis-je faire si mon OEM ne fournit pas encore un microprogramme mis à jour?
Veuillez consulter l'article [Protection alternative pour les hôtes Windows Server2016 Hyper-V contre les vulnérabilités de canal auxiliaire d'exécution spéculative](https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>Comment vérifier la version d’ordinateur virtuel de mes machines virtuelles?
Exécutez les commandes PowerShell suivantes sur l'hôte Hyper-V:
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>Dois-je faire quelque chose d'autre pour protéger les machines virtuelles s’exécutant en «mode de compatibilité du processeur»?
Non.  Après avoir suivi les instructions de cette page, les nouvelles fonctionnalités de processeur seront également exposées aux machines virtuelles démarrées en mode de compatibilité du processeur.

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>Et si seule la moitié des machines de mon cluster a bénéficié d'une mise à jour du microprogramme?
Cela impactera la migration dynamique au sein de votre cluster.  Les machines virtuelles avec les nouvelles fonctionnalités de processeur ne seront pas en mesure de migrer dynamiquement vers des hôtes sans la mise à jour du microprogramme.  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>Comment puis-je vérifier que la machine virtuelle invité a accès aux nouvelles fonctionnalités de processeur?
Utilisez le module/script PowerShell «contrôle de spéculations».  Pour obtenir des instructions détaillées, consultez [cette page](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

